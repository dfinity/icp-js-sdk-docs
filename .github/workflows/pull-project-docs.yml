name: Pull Project Documentation

on:
  repository_dispatch:
    types: [submit-project-docs]
  workflow_dispatch:
    inputs:
      project_repository:
        description: "The project repository to pull docs from. An item with the corresponding `repository` must be defined in projects.json"
        required: true

jobs:
  pull-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        id: generate_token
        with:
          app-id: ${{ vars.PR_AUTOMATION_BOT_PUBLIC_APP_ID }}
          private-key: ${{ secrets.PR_AUTOMATION_BOT_PUBLIC_PRIVATE_KEY }}

      - name: Checkout this repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: dfinity/ci-tools/actions/setup-deno@main

      - name: Prepare parameters
        id: params
        run: |
          echo "project_repository=${{ github.event.client_payload.project_repository || inputs.project_repository }}" >> $GITHUB_OUTPUT

      - name: Pull project documentation
        env:
          TMPDIR: ${{ runner.temp }}
        run: |
          deno task pull-project-docs --project "${{ steps.params.outputs.project_repository }}"

      - name: Fetch project commit
        id: fetch-commit
        env:
          TMPDIR: ${{ runner.temp }}
        run: |
          deno task fetch-project-commit --project "${{ steps.params.outputs.project_repository }}" --token "${{ steps.generate_token.outputs.token }}"

      - name: Create pull request
        uses: dfinity/ci-tools/actions/create-pr@main
        with:
          branch_name: "build/docs-update"
          base_branch_name: "main"
          pull_request_title: "build: update project docs from ${{ steps.params.outputs.project_repository }}@${{ steps.fetch-commit.outputs.commit_short_sha }}"
          pull_request_body: "This pull request was automatically created to update the project documentation from ${{ steps.params.outputs.project_repository }}@${{ steps.fetch-commit.outputs.commit_sha }}."
          commit_message: "build: update docs from ${{ steps.params.outputs.project_repository }}@${{ steps.fetch-commit.outputs.commit_sha }}"
          token: ${{ steps.generate_token.outputs.token }}
